<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å½¼å¥³ã‚¹ã‚¤ã‚«ã‚²ãƒ¼ãƒ  ğŸ¾</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* â–¼â–¼â–¼ ãƒãƒ¡é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼â–¼â–¼ */
  body {
    margin: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    background-color: #fff8e7; /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
    background-image: radial-gradient(#fff0d0 10%, transparent 10%); /* æ°´ç‰ */
    background-size: 20px 20px;
    overflow: hidden;
    touch-action: none; /* ã‚¹ãƒãƒ›ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ– */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: #5a4a42;
    -webkit-tap-highlight-color: transparent;
  }

  h1 { 
    margin: 5px 0 10px 0; 
    font-size: 1.4rem; 
    color: #8d5524;
    text-shadow: 2px 2px 0 #fff; 
  }

  /* ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³æ  */
  #game-container {
      width: 360px; /* ã‚¹ãƒãƒ›ã®æ¨ªå¹…ã«åˆã‚ã›ã‚‹ */
      height: 600px;
      border: 6px solid #e6cba8; /* å„ªã—ã„èŒ¶è‰²ã®æ  */
      border-radius: 20px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 8px 20px rgba(141, 85, 36, 0.2);
      position: relative;
      overflow: hidden;
  }

  canvas {
      display: block;
      border-radius: 14px; /* ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ã‚‚å°‘ã—ä¸¸ã */
  }

  /* æ¬¡ã®ãƒœãƒ¼ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #next-area {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 70px;
      height: 80px;
      background: #fff;
      border: 3px solid #ffb347;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  #next-label { font-size: 10px; font-weight: bold; color: #ffb347; margin-bottom: 2px; }
  #next-ball-preview {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid #fff8e7;
  }

  /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
  #score-board {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #ff8ba7;
      text-shadow: 1px 1px 0 #fff;
      pointer-events: none;
  }
  #score-label { font-size: 0.8rem; color: #8d5524; }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
  #loading-screen {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #fff8e7;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      transition: opacity 0.5s;
  }
  .spinner {
      width: 40px; height: 40px;
      border: 5px solid #e6cba8;
      border-top: 5px solid #ffb347;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ï¼ˆç‚¹ç·šï¼‰ */
  #danger-line {
      position: absolute;
      top: 100px; /* ä¸Šã‹ã‚‰100px */
      left: 0;
      width: 100%;
      height: 0;
      border-top: 2px dashed rgba(255, 0, 0, 0.3);
      pointer-events: none;
      z-index: 5;
  }
</style>
</head>
<body>

<h1>ğŸ¾ å½¼å¥³ã‚¹ã‚¤ã‚«ã‚²ãƒ¼ãƒ  ğŸ¶</h1>

<div id="game-container">
    <div id="loading-screen">
        <div class="spinner"></div>
        <div>ç”»åƒã‚’æº–å‚™ä¸­ã ãƒ¯ãƒ³...</div>
    </div>

    <div id="score-board">
        <span id="score-label">Score</span><br>
        <span id="score">0</span>
    </div>
    
    <div id="next-area">
        <div id="next-label">NEXT</div>
        <div id="next-ball-preview"></div>
    </div>
    
    <div id="danger-line"></div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<script>
  // â–¼â–¼â–¼ 11æ®µéšã®è¨­å®šï¼ˆåŠå¾„ã¨ç”»åƒï¼‰ â–¼â–¼â–¼
  // ç”»åƒã¯ 1.png ã€œ 11.png ã‚’èª­ã¿è¾¼ã¿ã¾ã™
  // radius: ãƒœãƒ¼ãƒ«ã®å¤§ãã•ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
  const FRUIT_LEVELS = [
      { level: 1,  radius: 22,  img: '1.png' },  // ã•ãã‚‰ã‚“ã¼å½¹
      { level: 2,  radius: 32,  img: '2.png' },  // ã„ã¡ã”å½¹
      { level: 3,  radius: 40,  img: '3.png' },  // ã¶ã©ã†å½¹
      { level: 4,  radius: 45,  img: '4.png' },  // ãƒ‡ã‚³ãƒãƒ³å½¹
      { level: 5,  radius: 55,  img: '5.png' },  // ã‹ãå½¹
      { level: 6,  radius: 62,  img: '6.png' },  // ã‚Šã‚“ã”å½¹
      { level: 7,  radius: 70,  img: '7.png' },  // ãªã—å½¹
      { level: 8,  radius: 85,  img: '8.png' },  // ã‚‚ã‚‚å½¹
      { level: 9,  radius: 95,  img: '9.png' },  // ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«å½¹
      { level: 10, radius: 105, img: '10.png' }, // ãƒ¡ãƒ­ãƒ³å½¹
      { level: 11, radius: 120, img: '11.png' }  // ã‚¹ã‚¤ã‚«å½¹ï¼ˆå½¼å¥³ï¼ï¼‰
  ];
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  const { Engine, Render, Runner, World, Bodies, Body, Events, Composite } = Matter;

  // ã‚²ãƒ¼ãƒ å¤‰æ•°
  let engine, render, runner;
  let currentBall = null;
  let nextLevelIndex = 0;
  let canDrop = false;
  let score = 0;
  
  // ç”»åƒã®æ‹¡å¤§ç¸®å°ç‡ã‚’ä¿å­˜ã™ã‚‹è¾æ›¸
  const imageScales = {}; 

  const container = document.getElementById('game-container');
  const scoreEl = document.getElementById('score');
  const nextPreviewEl = document.getElementById('next-ball-preview');
  const loadingScreen = document.getElementById('loading-screen');

  // --- 1. æº–å‚™ï¼šç”»åƒã‚’å…ˆèª­ã¿ã—ã¦ã‚µã‚¤ã‚ºã‚’è¨ˆç®— ---
  async function preloadImages() {
      const promises = FRUIT_LEVELS.map((fruit, index) => {
          return new Promise((resolve, reject) => {
              const img = new Image();
              img.src = fruit.img;
              img.onload = () => {
                  // ç”»åƒã®å…ƒã®å¤§ãã•ã‹ã‚‰ã€ãƒœãƒ¼ãƒ«ã®åŠå¾„ã«åˆã‚ã›ã‚‹ãŸã‚ã®ç¸®å°ºã‚’è¨ˆç®—
                  // (åŠå¾„ * 2) / ç”»åƒã®å¹… = ç¸®å°º
                  const scale = (fruit.radius * 2.1) / img.width; // 2.1ã¯å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ãŸã‚
                  imageScales[index] = scale;
                  resolve();
              };
              img.onerror = () => {
                  console.error("ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: " + fruit.img);
                  // å¤±æ•—æ™‚ã¯ã¨ã‚Šã‚ãˆãšé©å½“ãªã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…¥ã‚Œã‚‹
                  imageScales[index] = 1; 
                  resolve();
              };
          });
      });
      
      await Promise.all(promises);
      
      // èª­ã¿è¾¼ã¿å®Œäº†ã—ãŸã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
      loadingScreen.style.opacity = 0;
      setTimeout(() => {
          loadingScreen.style.display = 'none';
          initGame();
      }, 500);
  }

  // --- 2. ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ---
  function initGame() {
      // ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
      engine = Engine.create();
      engine.world.gravity.y = 1.5; // é‡åŠ›ã‚’å°‘ã—å¼·ã‚ã«ï¼ˆã‚­ãƒ“ã‚­ãƒ“ã•ã›ã‚‹ï¼‰

      // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
      render = Render.create({
          element: container,
          engine: engine,
          options: {
              width: 360,
              height: 600,
              wireframes: false,
              background: 'transparent',
              pixelRatio: window.devicePixelRatio // ã‚¹ãƒãƒ›ã§ç¶ºéº—ã«è¦‹ã›ã‚‹
          }
      });

      // å£ã¨åºŠã‚’ä½œæˆ
      const walls = [
          Bodies.rectangle(180, 615, 360, 30, { isStatic: true, render: { fillStyle: '#e6cba8' } }), // åºŠ
          Bodies.rectangle(-15, 300, 30, 600, { isStatic: true, render: { fillStyle: '#e6cba8' } }), // å·¦å£
          Bodies.rectangle(375, 300, 30, 600, { isStatic: true, render: { fillStyle: '#e6cba8' } })  // å³å£
      ];
      World.add(engine.world, walls);

      // æœ€åˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      Render.run(render);
      runner = Runner.create();
      Runner.run(runner, engine);
      
      // è¡çªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      Events.on(engine, 'collisionStart', handleCollision);

      // æœ€åˆã®ãƒœãƒ¼ãƒ«ç”Ÿæˆ
      updateNextBall();
      spawnReadyBall();
  }

  // --- 3. ãƒœãƒ¼ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
  function createFruit(x, y, index, isStatic = false) {
      const fruit = FRUIT_LEVELS[index];
      const scale = imageScales[index] || 1;

      return Bodies.circle(x, y, fruit.radius, {
          isStatic: isStatic,
          label: 'fruit_' + index, // ãƒ¬ãƒ™ãƒ«ã‚’ãƒ©ãƒ™ãƒ«ã«ä¿å­˜
          restitution: 0.2, // è·³ã­è¿”ã‚Š
          friction: 0.05,   // æ‘©æ“¦
          render: {
              sprite: {
                  texture: fruit.img,
                  xScale: scale,
                  yScale: scale
              }
          }
      });
  }

  // æ¬¡ã®ãƒœãƒ¼ãƒ«ã‚’æ±ºã‚ã‚‹
  function updateNextBall() {
      // æœ€åˆã¯Lv1(0)ã€œLv3(2)ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºç¾
      nextLevelIndex = Math.floor(Math.random() * 3);
      
      // NEXTè¡¨ç¤ºã‚’æ›´æ–°
      const nextFruit = FRUIT_LEVELS[nextLevelIndex];
      nextPreviewEl.style.backgroundImage = `url(${nextFruit.img})`;
  }

  // ç”»é¢ä¸Šã«è½ã¨ã™å‰ã®ãƒœãƒ¼ãƒ«ã‚’ã‚»ãƒƒãƒˆ
  function spawnReadyBall() {
      if (currentBall) return;
      
      // ç”»é¢ä¸­å¤®ä¸Š(x=180, y=50)ã«é…ç½®
      currentBall = createFruit(180, 50, nextLevelIndex, true);
      // è¡çªåˆ¤å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
      currentBall.collisionFilter = { group: -1 };
      
      World.add(engine.world, currentBall);
      canDrop = true;
  }

  // --- 4. æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ ---
  container.addEventListener('touchstart', handleInput, { passive: false });
  container.addEventListener('mousedown', handleInput);

  function handleInput(e) {
      if (!canDrop || !currentBall) return;
      e.preventDefault();

      // ã‚¿ãƒƒãƒ—ä½ç½®ã®Xåº§æ¨™ã‚’å–å¾—
      let clientX;
      if (e.type === 'touchstart') {
          clientX = e.touches[0].clientX;
      } else {
          clientX = e.clientX;
      }

      const rect = container.getBoundingClientRect();
      const x = clientX - rect.left;

      // å£ã«åŸ‹ã¾ã‚‰ãªã„ã‚ˆã†ã«ä½ç½®åˆ¶é™
      const fruit = FRUIT_LEVELS[nextLevelIndex];
      const minX = fruit.radius + 15; // å£ã®åšã¿è€ƒæ…®
      const maxX = 360 - fruit.radius - 15;
      const clampedX = Math.max(minX, Math.min(maxX, x));

      // 1. ã¾ãšæŒ‡ã®ä½ç½®ã«ç§»å‹•
      Body.setPosition(currentBall, { x: clampedX, y: 50 });

      // 2. å›ºå®šè§£é™¤ã—ã¦è½ä¸‹ï¼
      Body.setStatic(currentBall, false);
      currentBall.collisionFilter = { group: 0 }; // è¡çªæœ‰åŠ¹åŒ–
      
      currentBall = null;
      canDrop = false;

      // 3. æ¬¡ã®æº–å‚™
      updateNextBall();
      setTimeout(spawnReadyBall, 800); // 0.8ç§’å¾Œã«æ¬¡ã‚’ã‚»ãƒƒãƒˆ
  }

  // --- 5. åˆä½“ï¼ˆé€²åŒ–ï¼‰ãƒ­ã‚¸ãƒƒã‚¯ ---
  function handleCollision(event) {
      const pairs = event.pairs;

      for (let i = 0; i < pairs.length; i++) {
          const bodyA = pairs[i].bodyA;
          const bodyB = pairs[i].bodyB;

          // ä¸¡æ–¹ãŒãƒ•ãƒ«ãƒ¼ãƒ„ã‹ã©ã†ã‹ç¢ºèª
          if (bodyA.label.startsWith('fruit_') && bodyB.label === bodyA.label) {
              const level = parseInt(bodyA.label.split('_')[1]);

              // æœ€å¤§ãƒ¬ãƒ™ãƒ«(11=index 10)ã§ãªã‘ã‚Œã°é€²åŒ–
              if (level < FRUIT_LEVELS.length - 1) {
                  // è¡çªã—ãŸä½ç½®ã®ä¸­é–“
                  const midX = (bodyA.position.x + bodyB.position.x) / 2;
                  const midY = (bodyA.position.y + bodyB.position.y) / 2;

                  // å¤ã„ãƒœãƒ¼ãƒ«ã‚’æ¶ˆã™
                  World.remove(engine.world, [bodyA, bodyB]);

                  // æ–°ã—ã„ãƒœãƒ¼ãƒ«ã‚’ä½œã‚‹ï¼ˆ1ãƒ©ãƒ³ã‚¯ä¸Šï¼‰
                  const newBall = createFruit(midX, midY, level + 1);
                  World.add(engine.world, newBall);

                  // ã‚¹ã‚³ã‚¢åŠ ç®—
                  // å°ã•ã„ç‰ã»ã©ä½ã„ç‚¹ã€å¤§ãã„ç‰ã»ã©é«˜ã„ç‚¹
                  score += (level + 1) * 2;
                  scoreEl.textContent = score;
                  
                  // åŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ ã§å¤šé‡è¡çªã—ãªã„ã‚ˆã†ã«IDæ›¸ãæ›ãˆç­‰ã®å·¥å¤«ã‚‚ã§ãã‚‹ãŒ
                  // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å‰Šé™¤ã§å¯¾å¿œ
                  break; // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã«1é€²åŒ–ã«åˆ¶é™ã—ã¦ãƒã‚°é˜²æ­¢
              }
          }
      }
  }

  // ã‚¹ã‚¿ãƒ¼ãƒˆï¼
  preloadImages();

</script>
</body>
</html>
